{"ignition":{"config":{},"timeouts":{},"version":"2.1.0"},"networkd":{},"passwd":{"users":[{"name":"core","sshAuthorizedKeys":["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQD0b7/p6r/OB0ETmuWANndHdVlFzDA1vSD0ByO6/wbcwiz8265oWajfmCmrEhTEG6WMX5RQWZ2L/56Sb+MlcZQpZp77QKikgyqpfJdHuyq1bAIvfbl9Z8Ms1zYQMjdlOVbdNxQV7F3eMoh7bFIoXsDiatbPxEf8H9TkJI1UaPT1Gw== core@example.com"]}]},"storage":{"files":[{"filesystem":"root","group":{},"path":"/srv/setup-etcd2-discovery-env","user":{"name":"root"},"contents":{"source":"data:,%23!%2Fusr%2Fbin%2Fenv%20sh%0AENV_FILE_PATH%3D%2Fetc%2Fetcd2.env%0A%0ALINE%3D%24(%2Fusr%2Fshare%2Foem%2Fbin%2Fvmtoolsd%20--cmd%20%22info-get%20guestinfo.ovfEnv%22%20%7C%20grep%20guestinfo.etcd.discovery.url)%0ALINE%3D%24%7BLINE%23%23*oe%3Avalue%3D%7D%0AURL%3D%24%7BLINE%25%2F%3E%7D%0Aecho%20ETCD_DISCOVERY%3D%24%7BURL%7D%20%3E%20%24%7BENV_FILE_PATH%7D%0A","verification":{}},"mode":493},{"filesystem":"root","group":{},"path":"/srv/advertise-swarm-node","user":{"name":"root"},"contents":{"source":"data:,%23!%2Fusr%2Fbin%2Fenv%20sh%0A%0A%2Fusr%2Fbin%2Fdocker%20run%20--name%20swarm%20%5C%0A%20%20--restart%3Dunless-stopped%20%5C%0A%20%20-d%20swarm%20%5C%0A%20%20join%20%5C%0A%20%20--advertise%3D%24COREOS_PRIVATE_IPV4%3A2375%20%5C%0A%20%20etcd%3A%2F%2F%24COREOS_PRIVATE_IPV4%3A2379%0A","verification":{}},"mode":493},{"filesystem":"root","group":{},"path":"/srv/advertise-swarm-manager","user":{"name":"root"},"contents":{"source":"data:,%23!%2Fbin%2Fbash%0A%0A%2Fusr%2Fbin%2Fdocker%20run%20--name%20swarm-manager%20%5C%0A%20%20--restart%3Dunless-stopped%20%5C%0A%20%20-p%209999%3A2375%20%5C%0A%20%20-d%20swarm%20%5C%0A%20%20manage%20%5C%0A%20%20--replication%20%5C%0A%20%20--advertise%20%24COREOS_PRIVATE_IPV4%3A9999%20%5C%0A%20%20etcd%3A%2F%2F%24COREOS_PRIVATE_IPV4%3A2379%0A","verification":{}},"mode":493},{"filesystem":"root","group":{},"path":"/etc/coreos/update.conf","user":{},"contents":{"source":"data:,GROUP%3Dstable%0AREBOOT_STRATEGY%3D%22etcd-lock%22%0ALOCKSMITHD_REBOOT_WINDOW_START%3D%22Fri%2017%3A00%22%0ALOCKSMITHD_REBOOT_WINDOW_LENGTH%3D%221h30m%22","verification":{}},"mode":420}]},"systemd":{"units":[{"dropins":[{"contents":"[Service]\nExecStart=\nExecStart=/usr/lib/coreos/etcd-wrapper $ETCD_OPTS \\\n  --heartbeat-interval=500 \\\n  --election-timeout=2500 \\\n  --listen-peer-urls=\"http://0.0.0.0:2380\" \\\n  --listen-client-urls=\"http://0.0.0.0:2379,http://0.0.0.0:4001\" \\\n  --initial-advertise-peer-urls=\"http://$COREOS_PRIVATE_IPV4:2380\" \\\n  --advertise-client-urls=\"http://$COREOS_PRIVATE_IPV4:2379,http://$COREOS_PRIVATE_IPV4:4001\"","name":"20-clct-etcd-member.conf"}],"enable":true,"name":"etcd-member.service"},{"contents":"[Unit]\nDescription=Mount /var/lib/docker\n[Mount]\nWhat=/dev/vg01/docker_vol\nWhere=/var/lib/docker\nType=ext4\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"var-lib-docker.mount"},{"dropins":[{"contents":"[Socket]\nListenStream=2375\n","name":"20-tcp-listen-stream.conf"}],"name":"docker.socket"},{"dropins":[{"contents":"[Unit]\nAfter=docker.socket network.target var-lib-docker.mount etcd-member.service\nRequires=docker.socket var-lib-docker.mount etcd-member.service\n","name":"10-wait-docker.conf"},{"contents":"[Service]\nEnvironment=\"DOCKER_OPTS=--log-driver=journald --cluster-store=etcd://localhost:2379 --cluster-advertise=ens192:2375\"\n","name":"20-docker.conf"}],"name":"docker.service"},{"contents":"[Unit]\nDescription=Set the time zone\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/usr/bin/timedatectl set-timezone Asia/Shanghai\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"settimezone.service"},{"contents":"[Unit]\nDescription=Set etcd discovery url from ovfEnv\nRequires=vmtoolsd.service\nAfter=vmtoolsd.service\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStartPre=/usr/bin/echo 'Writing file to \"/etc/etcd2.env\"'\nExecStart=/srv/setup-etcd2-discovery-env\nExecStart=/usr/bin/echo 'Wrote file to \"/etc/etcd2.env\"'\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"etcd2-discovery-url.service"},{"dropins":[{"contents":"[Unit]\nRequires=etcd2-discovery-url.service\nAfter=etcd2-discovery-url.service\n[Service]\nEnvironmentFile=/etc/etcd2.env\n","name":"30-discovery.conf"}],"name":"etcd-member.service"},{"contents":"[Unit]\nDescription=Advertise this node as a docker swarm node\nRequires=docker.service etcd2.service\nAfter=docker.service etcd-member.service\n[Service]\nExecStartPre=-/usr/bin/docker kill %p\nExecStartPre=-/usr/bin/docker rm -v %p\nExecStart=/usr/bin/docker run --rm --name %p \\\n    swarm \\\n    join \\\n    --advertise=$COREOS_PRIVATE_IPV4:2375 \\\n    etcd://$COREOS_PRIVATE_IPV4:2379\nExecStop=/usr/bin/docker stop %p\nRestart=always\nRestartSec=10s\nTimeoutStartSec=120\nTimeoutStopSec=15\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"advertise-swarm-node.service"},{"contents":"[Unit]\nDescription=Advertise this node as a docker swarm manager\nRequires=docker.service etcd2.service\nAfter=docker.service etcd-member.service\n[Service]\nExecStartPre=-/usr/bin/docker kill %p\nExecStartPre=-/usr/bin/docker rm -v %p\nExecStart=/usr/bin/docker run --rm --name %p \\\n    -p 9999:2375 \\\n    swarm \\\n    manage \\\n    --replication \\\n    --advertise $COREOS_PRIVATE_IPV4:9999 \\\n    etcd://$COREOS_PRIVATE_IPV4:2379\nExecStop=/usr/bin/docker stop %p\nRestart=always\nRestartSec=10s\nTimeoutStartSec=120\nTimeoutStopSec=15\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"advertise-swarm-manager.service"}]}}